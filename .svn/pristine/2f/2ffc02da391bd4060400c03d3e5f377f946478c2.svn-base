namespace ENTITY
{
    using System;
    using System.Collections.Generic;
    using System.ComponentModel.DataAnnotations;
    using System.ComponentModel.DataAnnotations.Schema;
    using System.Data.Entity.Spatial;
    using System.Linq;
    using System.Data.Entity;
    using System.Data.Entity.Validation;
    using System.Diagnostics;
    using CapaNegocio;
    using System.Data.Entity.SqlServer;

    using System.Data.SqlClient;
    public partial class AL0003MOVC
    {
        [Key]
        [Column(Order = 0)]
        [StringLength(4)]
        public string C5_CALMA { get; set; }

        [Key]
        [Column(Order = 1)]
        [StringLength(2)]
        public string C5_CTD { get; set; }

        [Key]
        [Column(Order = 2)]
        [StringLength(11)]
        public string C5_CNUMDOC { get; set; }

        [Required]
        [StringLength(4)]
        public string C5_CLOCALI { get; set; }

        public DateTime? C5_DFECDOC { get; set; }

        public DateTime? C5_DFECVEN { get; set; }

        [Required]
        [StringLength(1)]
        public string C5_CTIPMOV { get; set; }

        [Required]
        [StringLength(2)]
        public string C5_CCODMOV { get; set; }


        [StringLength(1)]
        public string C5_CSITUA { get; set; }


        [StringLength(2)]
        public string C5_CRFTDOC { get; set; }


        [StringLength(24)]
        public string C5_CRFNDOC { get; set; }


        [StringLength(3)]
        public string C5_CSOLI { get; set; }


        [StringLength(6)]
        public string C5_CCENCOS { get; set; }


        [StringLength(4)]
        public string C5_CRFALMA { get; set; }


        [StringLength(30)]
        public string C5_CGLOSA1 { get; set; }


        [StringLength(30)]
        public string C5_CGLOSA2 { get; set; }


        [StringLength(30)]
        public string C5_CGLOSA3 { get; set; }


        [StringLength(1)]
        public string C5_CTIPANE { get; set; }


        [StringLength(18)]
        public string C5_CCODANE { get; set; }

        public DateTime? C5_DFECCRE { get; set; }

        [Required]
        [StringLength(5)]
        public string C5_CUSUCRE { get; set; }

        public DateTime? C5_DFECMOD { get; set; }


        [StringLength(5)]
        public string C5_CUSUMOD { get; set; }


        [StringLength(18)]
        public string C5_CCODCLI { get; set; }


        [StringLength(50)]
        public string C5_CNOMCLI { get; set; }


        [StringLength(18)]
        public string C5_CRUC { get; set; }


        [StringLength(4)]
        public string C5_CCODCAD { get; set; }


        [StringLength(10)]
        public string C5_CCODINT { get; set; }


        [StringLength(18)]
        public string C5_CCODTRA { get; set; }


        [StringLength(50)]
        public string C5_CNOMTRA { get; set; }


        [StringLength(18)]
        public string C5_CCODVEH { get; set; }


        [StringLength(2)]
        public string C5_CTIPGUI { get; set; }


        [StringLength(1)]
        public string C5_CSITGUI { get; set; }


        [StringLength(1)]
        public string C5_CGUIFAC { get; set; }


        [StringLength(4)]
        public string C5_CDESTIN { get; set; }


        [StringLength(80)]
        public string C5_CDIRENV { get; set; }


        [StringLength(20)]
        public string C5_CNUMORD { get; set; }


        [StringLength(1)]
        public string C5_CTIPORD { get; set; }


        [StringLength(1)]
        public string C5_CGUIDEV { get; set; }


        [StringLength(18)]
        public string C5_CCODPRO { get; set; }


        [StringLength(50)]
        public string C5_CNOMPRO { get; set; }


        [StringLength(4)]
        public string C5_CCIAS { get; set; }


        [StringLength(3)]
        public string C5_CFORVEN { get; set; }


        [StringLength(2)]
        public string C5_CCODMON { get; set; }


        [StringLength(5)]
        public string C5_CVENDE { get; set; }

        [Column(TypeName = "numeric")]
        public decimal C5_NTIPCAM { get; set; }


        [StringLength(4)]
        public string C5_CCODAGE { get; set; }


        [StringLength(11)]
        public string C5_CNUMPED { get; set; }


        [StringLength(80)]
        public string C5_CDIRECC { get; set; }

        [Column(TypeName = "numeric")]
        public decimal C5_NIMPORT { get; set; }


        [StringLength(1)]
        public string C5_CTIPO { get; set; }


        [StringLength(4)]
        public string C5_CSUBDIA { get; set; }


        [StringLength(6)]
        public string C5_CCOMPRO { get; set; }

        [Column(TypeName = "numeric")]
        public decimal C5_NPORDE1 { get; set; }

        [Column(TypeName = "numeric")]
        public decimal C5_NPORDE2 { get; set; }


        [StringLength(2)]
        public string C5_CTF { get; set; }

        [Column(TypeName = "numeric")]
        public decimal C5_NFLETE { get; set; }


        [StringLength(15)]
        public string C5_CCODAUT { get; set; }


        [StringLength(2)]
        public string C5_CRFTDO2 { get; set; }


        [StringLength(24)]
        public string C5_CRFNDO2 { get; set; }


        [StringLength(23)]
        public string C5_CNUMLIQ { get; set; }


        [StringLength(18)]
        public string C5_CORDEN { get; set; }


        [StringLength(1)]
        public string C5_CTIPOGS { get; set; }

        public DateTime? C5_DFECANU { get; set; }


        [StringLength(18)]
        public string C5_CCODFER { get; set; }

        public DateTime? C5_DFECEMB { get; set; }


        [StringLength(50)]
        public string C5_CGLOSA4 { get; set; }


        [StringLength(5)]
        public string C5_CVENDE2 { get; set; }


        [StringLength(1)]
        public string C5_CESTDEV { get; set; }


        [StringLength(1)]
        public string C5_CEXTOR { get; set; }


        [StringLength(80)]
        public string C5_CRENOM { get; set; }


        [StringLength(18)]
        public string C5_CRERUC { get; set; }


        [StringLength(80)]
        public string C5_CREREF { get; set; }


        [StringLength(80)]
        public string C5_CDSNOM { get; set; }


        [StringLength(18)]
        public string C5_CDSRUC { get; set; }


        [StringLength(12)]
        public string C5_CLLECIU { get; set; }


        [StringLength(12)]
        public string C5_CPARCIU { get; set; }


        [StringLength(10)]
        public string C5_CTTRACT { get; set; }


        [StringLength(10)]
        public string C5_CTRASRE { get; set; }


        [StringLength(10)]
        public string C5_CTRAREM { get; set; }


        [StringLength(25)]
        public string C5_CLICCON { get; set; }


        [StringLength(80)]
        public string C5_CSBNOM { get; set; }


        [StringLength(18)]
        public string C5_CSBRUC { get; set; }


        [StringLength(25)]
        public string C5_CSBMTC { get; set; }


        [StringLength(2)]
        public string C5_CMONPER { get; set; }

        [Column(TypeName = "numeric")]
        public decimal C5_NIMPPER { get; set; }


        [StringLength(1)]
        public string C5_CFPERCP { get; set; }


        [StringLength(1)]
        public string C5_CESTFIN { get; set; }


        [StringLength(1)]
        public string C5_CFLGPEN { get; set; }


        [StringLength(2)]
        public string C5_CTIPFOR { get; set; }

        [Column(TypeName = "numeric")]
        public decimal C5_NPORPER { get; set; }


        [StringLength(1)]
        public string C5_CFLGTRM { get; set; }


        [StringLength(18)]
        public string C5_CAGETRA { get; set; }


        [StringLength(30)]
        public string C5_CCONTAI { get; set; }

        public static Boolean insertaCabeceraEntrada(AL0003MOVC datos)
        {
            Boolean band = true;
            var fechaA = DateTime.Now;
            var NALM = new AL0003ALMA();
            try
            {
                using (var ctx = new RSFACAR())
                {
                    //NUEVO
                    NALM.A1_CALMA = datos.C5_CALMA;
                    if (datos.C5_CTIPMOV == "E")
                    {

                        NALM.A1_NNUMENT = Convert.ToDecimal(datos.C5_CNUMDOC);

                    }
                    else if (datos.C5_CTIPMOV == "S")
                    {
                        NALM.A1_NNUMSAL = Convert.ToDecimal(datos.C5_CNUMDOC);
                    }
                    NALM.A1_CUSUMOD = datos.C5_CUSUCRE;
                    NALM.A1_DFECMOD = fechaA;
                    AL0003ALMA.actualizaNumeracion(NALM);//ACTUALIZA NUMERACION

                    ctx.Entry(datos).State = EntityState.Added;
                    ctx.SaveChanges();
                }
            }


            catch (DbEntityValidationException dbEx)
            {
                foreach (var validationErrors in dbEx.EntityValidationErrors)
                {
                    foreach (var validationError in validationErrors.ValidationErrors)
                    {
                        Trace.TraceInformation("Property: {0} Error: {1}", validationError.PropertyName, validationError.ErrorMessage);
                    }
                }
                band = false;
            }
            return band;
        }

        public static Boolean aprobarpe(AL0003MOVC DATA)
        {
            Boolean band = true;
            //int COUNT;
            var fechaA = DateTime.Now;
            var data = new AL0003MOVC { C5_CALMA = DATA.C5_CALMA, C5_CTD = DATA.C5_CTD, C5_CNUMDOC = DATA.C5_CNUMDOC };
            //var datad = new AL0003MOVD { C6_CALMA = datos.C5_CALMA, C6_CTD = datos.C5_CTD, C6_CNUMDOC = datos.C5_CNUMDOC };
            try
            {
                using (var ctx = new RSFACAR())
                {
                    //COUNT = ctx.AL0003MOVD.Where(x => x.C6_CALMA == DATA.C5_CALMA && x.C6_CTD == DATA.C5_CTD && x.C6_CNUMDOC == DATA.C5_CNUMDOC).Count();
                    ctx.AL0003MOVC.Attach(data);
                    //data.C5_DFECMOD = fechaA;
                    //data.C5_CUSUMOD = DATA.C5_CUSUMOD;
                    data.C5_CCODAUT = DATA.C5_CCODAUT;
                    data.C5_DFECEMB = fechaA;
                    ctx.Configuration.ValidateOnSaveEnabled = false;
                    ctx.SaveChanges();

                    //NITEM = COUNT.ToString("D4");
                    /*for (int i = 1; i <= COUNT; i++)
                    {
                        string MITEM;
                        MITEM = i.ToString("D4");
                        AL0003MOVD.actualizaDetalleEntrada(datad, MITEM);
                    }*/

                }
            }
            catch (DbEntityValidationException dbEx)
            {
                foreach (var validationErrors in dbEx.EntityValidationErrors)
                {
                    foreach (var validationError in validationErrors.ValidationErrors)
                    {
                        Trace.TraceInformation("Property: {0} Error: {1}", validationError.PropertyName, validationError.ErrorMessage);
                    }
                }
                band = false;
            }
            return band;
        }

        /// <summary>
        /// Actualiza cabecera
        /// filtros:
        /// Actualizacion: 12/04/2016
        /// Nota: Se agrego metodo para actualizar fecha de detalle
        /// </summary>
        /// <param name="datos"></param>
        /// <returns></returns>
        public static Boolean actualizaCabeceraEntrada(AL0003MOVC datos)
        {
            Boolean band = true;
            int COUNT;
            var fechaA = DateTime.Now;
            var data = new AL0003MOVC { C5_CALMA = datos.C5_CALMA, C5_CTD = datos.C5_CTD, C5_CNUMDOC = datos.C5_CNUMDOC };
            var datad = new AL0003MOVD { C6_CALMA = datos.C5_CALMA, C6_CTD = datos.C5_CTD, C6_CNUMDOC = datos.C5_CNUMDOC };
            try
            {
                using (var ctx = new RSFACAR())
                {
                    COUNT = ctx.AL0003MOVD.Where(x => x.C6_CALMA == datos.C5_CALMA && x.C6_CTD == datos.C5_CTD && x.C6_CNUMDOC == datos.C5_CNUMDOC).Count();
                    //ctx.tabla_menuusuarios.Where(x => x.USUA == codusuario && x.URL.Replace("/SEALOGISTICA", "") == urll).Count();
                    ctx.AL0003MOVC.Attach(data);
                    datad.C6_DFECDOC = datos.C5_DFECDOC;
                    data.C5_DFECDOC = datos.C5_DFECDOC;
                    data.C5_CCODMOV = datos.C5_CCODMOV;//CODIGO MOVIMIENTO
                    data.C5_CSOLI = datos.C5_CSOLI;//SOLICITANTE
                    data.C5_CORDEN = datos.C5_CORDEN;//BAHIA
                    data.C5_CCODPRO = datos.C5_CCODPRO;
                    data.C5_CNOMPRO = datos.C5_CNOMPRO;
                    data.C5_CRFNDO2 = datos.C5_CRFNDO2;//ORIGEN
                    data.C5_CGLOSA1 = datos.C5_CGLOSA1;
                    data.C5_CGLOSA2 = datos.C5_CGLOSA2;
                    data.C5_CGLOSA3 = datos.C5_CGLOSA3;
                    data.C5_CGLOSA4 = datos.C5_CGLOSA4;//DER
                    data.C5_CCODFER = datos.C5_CCODFER;//TICKET PESAJE
                    data.C5_DFECMOD = fechaA;
                    data.C5_CUSUMOD = datos.C5_CUSUMOD;
                    data.C5_CCENCOS = datos.C5_CCENCOS;
                    ctx.Configuration.ValidateOnSaveEnabled = false;
                    ctx.SaveChanges();

                    //NITEM = COUNT.ToString("D4");
                    for (int i = 1; i <= COUNT; i++)
                    {
                        string MITEM;
                        MITEM = i.ToString("D4");
                        AL0003MOVD.actualizaDetalleEntrada(datad, MITEM);
                    }

                }
            }
            catch (DbEntityValidationException dbEx)
            {
                foreach (var validationErrors in dbEx.EntityValidationErrors)
                {
                    foreach (var validationError in validationErrors.ValidationErrors)
                    {
                        Trace.TraceInformation("Property: {0} Error: {1}", validationError.PropertyName, validationError.ErrorMessage);
                    }
                }
                band = false;
            }
            return band;
        }

        public static List<AL0003MOVC> listaNRODOCUMENTO(string ND, string ES, string TD, string AL)
        {
            List<AL0003MOVC> listND = new List<AL0003MOVC>();
            try
            {
                using (var ctx = new RSFACAR())
                {
                    listND = ctx.AL0003MOVC.Where(x => x.C5_CTIPMOV == ES && x.C5_CTD == TD
                                                  && x.C5_CALMA == AL
                                                  && SqlFunctions.PatIndex(ND, x.C5_CNUMDOC) > 0).ToList();

                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND;
        }
        public static AL0003MOVC obtenerCabecera(string ES, string TD, string AL, string ND)
        {
            //NO HA HABIDO NADA OPERACION YA. CON TODOS.
            var datos = new AL0003MOVC();
            try
            {
                using (var ctx = new RSFACAR())
                {
                    datos = ctx.AL0003MOVC.Where(x => x.C5_CTIPMOV == ES && x.C5_CTD == TD && x.C5_CALMA == AL && x.C5_CNUMDOC.Contains(ND)).FirstOrDefault();

                }
            }
            catch (Exception)
            {
                throw;
            }
            return datos;
        }
        public static string codMaximo(string ALM, string TDOC)
        {
            Int64 cuenta = 0; string codID;
            try
            {
                using (var ctx = new RSFACAR())
                {

                    cuenta = Convert.ToInt64(ctx.AL0003MOVC.Where(x => x.C5_CALMA == ALM && x.C5_CTD == TDOC && x.C5_CNUMDOC.Length == 11).Max(x => x.C5_CNUMDOC));

                }
            }
            catch (Exception)
            {

                throw;
            }

            cuenta = cuenta + 1;
            codID = cuenta.ToString("D11");
            return codID;
        }
        /// <summary>
        /// Correlativo Maximo por codigo mov.
        /// Creado:04.06.16
        /// Autor:William Castillo
        /// </summary>
        /// <param name="ALM"></param>
        /// <param name="TDOC"></param>
        /// <returns></returns>
        public static string codMaximoX(string ALM, string TDOC, string CM)
        {
            Int64 cuenta = 0; string codID;
            try
            {
                using (var ctx = new RSFACAR())
                {

                    cuenta = Convert.ToInt64(ctx.AL0003MOVC.Where(x => x.C5_CALMA == ALM && x.C5_CTD == TDOC && x.C5_CNUMDOC.Length == 11 && x.C5_CCODMOV == CM).Max(x => x.C5_CNUMDOC));

                }
            }
            catch (Exception)
            {

                throw;
            }

            cuenta = cuenta + 1;
            codID = cuenta.ToString("D11");
            return codID;
        }

        /// <summary>
        /// Lista Todos los documentos
        /// </summary>
        /// <param name="DATOS"></param>
        /// <returns></returns>
        public static List<Principal> listaDocumentos(AL0003MOVC DATOS)
        {
            //DateTime f1 = Convert.ToDateTime(FEC1);
            //DateTime f2 = (FEC2!=""?Convert.ToDateTime(FEC2): null);
            List<Principal> listND = new List<Principal>();
            try
            {
                using (var ctx = new RSFACAR())
                {
                    listND = (from c in ctx.AL0003MOVC
                              where
                                ((c.C5_CALMA == DATOS.C5_CALMA) &&
                                    (DATOS.C5_CTD != null ? c.C5_CTD == DATOS.C5_CTD : c.C5_CTD != DATOS.C5_CTD) &&
                                    (DATOS.C5_CCODMOV.Trim() != "" ? c.C5_CCODMOV == DATOS.C5_CCODMOV : c.C5_CCODMOV != DATOS.C5_CCODMOV) &&
                                    //(DATOS.C5_CCODCLI.Trim() != "" ? c.C5_CCODCLI == DATOS.C5_CCODCLI : c.C5_CCODCLI == DATOS.C5_CCODCLI) &&
                                    (DATOS.C5_DFECDOC != null && DATOS.C5_DFECVEN != null ? c.C5_DFECDOC >= DATOS.C5_DFECDOC && c.C5_DFECDOC <= DATOS.C5_DFECVEN : c.C5_DFECDOC == DATOS.C5_DFECDOC)
                                //(DATOS.C5_DFECDOC != null && DATOS.C5_DFECVEN != null ? c.C5_DFECDOC >= DATOS.C5_DFECDOC && c.C5_DFECDOC <= DATOS.C5_DFECVEN : c.C5_DFECDOC == DATOS.C5_DFECDOC)
                                )
                              select new
                              {
                                  var1 = c.C5_CALMA,
                                  var2 = c.C5_CTD,
                                  var3 = c.C5_CNUMDOC,
                                  var4 = c.C5_DFECDOC,
                                  var5 = c.C5_CTIPMOV,
                                  var6 = c.C5_CCODMOV,
                                  var7 = c.C5_CRFTDOC,
                                  var8 = c.C5_CRFNDOC,
                                  var9 = c.C5_CCENCOS,
                                  var10 = c.C5_CGLOSA1,
                                  var11 = c.C5_CGLOSA2,
                                  var12 = c.C5_CGLOSA3,
                                  var13 = c.C5_CCODCLI,
                                  var14 = c.C5_CNOMCLI,
                                  var15 = c.C5_CGUIFAC,
                                  var16 = c.C5_CNUMORD,
                                  var17 = c.C5_CCODPRO,
                                  var18 = c.C5_CNOMPRO,
                                  var19 = c.C5_CSUBDIA,
                                  var20 = c.C5_CCOMPRO,
                                  var21 = c.C5_CRFTDO2,
                                  var22 = c.C5_CRFNDO2,
                                  var23 = c.C5_CNUMLIQ,
                                  var24 = c.C5_CORDEN,
                                  var25 = c.C5_CCODFER
                              }).ToList().Select(d => new Principal()
                              {
                                  C5_CALMA = d.var1,
                                  C5_CTD = d.var2,
                                  C5_CNUMDOC = d.var3,
                                  C5_DFECDOC = String.Format("{0:dd/MM/yyyy}", d.var4),
                                  C5_CTIPMOV = d.var5,
                                  C5_CCODMOV = d.var6,
                                  C5_CRFTDOC = d.var7,
                                  C5_CRFNDOC = d.var8,
                                  C5_CCENCOS = d.var9,
                                  C5_CGLOSA1 = (d.var10 == null || d.var10.Trim() == "" ? "-" :
                                                ((d.var1 == "A002" || d.var1 == "A004" || d.var1 == "0004" || d.var1 == "0015" || d.var1 == "0009") && (d.var10.Trim().Length >= 10 && d.var10.Trim().Length <= 12) ?
                                                tabla_embarcaciones.ListarEID(d.var10.Trim()) :
                                                d.var10.Trim())),
                                  C5_CGLOSA2 = d.var11,
                                  C5_CGLOSA3 = d.var12,
                                  C5_CCODCLI = d.var13,
                                  C5_CNOMCLI = d.var14,
                                  C5_CGUIFAC = d.var15,
                                  C5_CNUMORD = d.var16,
                                  C5_CCODPRO = d.var17,
                                  C5_CNOMPRO = d.var18,
                                  C5_CSUBDIA = d.var19,
                                  C5_CCOMPRO = d.var20,
                                  C5_CRFTDO2 = d.var21,
                                  C5_CRFNDO2 = d.var22,
                                  C5_CNUMLIQ = d.var23,
                                  C5_CORDEN = d.var24,
                                  C5_CCODFER = d.var25
                              }).ToList();
                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND;
        }
        /// <summary>
        /// Listado para valorizacion
        /// Actualizacion:29.04.2016
        /// </summary>
        /// <param name="datos"></param>
        /// <returns></returns>
        public static List<Principal> listaFinal(AL0003MOVC datos)
        {
            //AL0003MOVC datos
            List<Principal> listND = new List<Principal>();
            try
            {
                DateTime f1 = Convert.ToDateTime(datos.C5_DFECDOC);
                using (var ctx = new RSFACAR())
                {
                    listND = (from c in ctx.AL0003MOVC
                              join d in ctx.AL0003MOVD
                                    on new { c.C5_CALMA, c.C5_CTD, c.C5_CNUMDOC }
                                equals new { C5_CALMA = d.C6_CALMA, C5_CTD = d.C6_CTD, C5_CNUMDOC = d.C6_CNUMDOC }
                              where
                                (c.C5_CALMA == datos.C5_CALMA && c.C5_CTD == datos.C5_CTD && c.C5_CNUMDOC == datos.C5_CNUMDOC)
                              //(c.C5_CALMA == datos.C5_CALMA && c.C5_CTD == datos.C5_CTD && (datos.C5_CNUMDOC ==""?c.C5_CNUMDOC!="" :c.C5_CNUMDOC == datos.C5_CNUMDOC) && (datos.C5_DFECDOC == null?c.C5_DFECDOC!=null:(c.C5_DFECDOC>=f1 && c.C5_DFECDOC<=f1)))
                              select new
                              {
                                  var0 = c.C5_CALMA,
                                  var1 = ((from t1 in ctx.AL0003ALMA
                                           where t1.A1_CALMA == c.C5_CALMA
                                           select new { t1.A1_CDESCRI }).FirstOrDefault().A1_CDESCRI),
                                  var2 = c.C5_CTD,
                                  var3 = c.C5_CNUMDOC,
                                  var4 = c.C5_CLOCALI,
                                  var5 = c.C5_DFECDOC,
                                  var6 = c.C5_CTIPMOV,
                                  var7 = c.C5_CCODMOV,
                                  var71 = ((from t2 in ctx.AL0003TABM
                                            where t2.TM_CCODMOV == c.C5_CCODMOV && t2.TM_CTIPMOV == c.C5_CTIPMOV
                                            select new { t2.TM_CDESCRI }).FirstOrDefault().TM_CDESCRI),
                                  var8 = c.C5_CSITUA,
                                  var9 = c.C5_CRFTDOC,
                                  var10 = c.C5_CRFNDOC,
                                  var101 = c.C5_CRFNDO2,  //ORIGEN
                                  var102 = c.C5_CORDEN,    //BAHIA
                                  var103 = c.C5_CSOLI, // SOLICITANTE
                                  var1031 = ((from t in ctx.AL0003TABL
                                              where t.TG_CCOD == "12" && t.TG_CCLAVE == c.C5_CSOLI
                                              select new { t.TG_CDESCRI }).FirstOrDefault().TG_CDESCRI),//AL0003TABL
                                  var11 = c.C5_CCENCOS,
                                  var111 = ((from t in ctx.AL0003TABL
                                             where t.TG_CCOD == "10" && t.TG_CCLAVE == c.C5_CCENCOS
                                             select new { t.TG_CDESCRI }).FirstOrDefault().TG_CDESCRI),//AL0003TABL
                                  var12 = c.C5_CRFALMA,
                                  var13 = c.C5_CGLOSA1,
                                  var14 = c.C5_CGLOSA2,
                                  var15 = c.C5_CGLOSA3,
                                  var16 = c.C5_CGLOSA4,
                                  var17 = c.C5_CCODPRO,
                                  var18 = c.C5_CNOMPRO,
                                  var19 = c.C5_DFECCRE,
                                  var20 = c.C5_CUSUCRE,
                                  var30 = c.C5_CCODAUT,
                                  var201 = c.C5_CNUMORD,
                                  var202 = c.C5_CCODMON,
                                  var203 = c.C5_CDESTIN,
                                  var204 = c.C5_CCODFER,
                                  var21 = d.C6_CITEM,
                                  var22 = d.C6_CCODIGO,
                                  var23 = d.C6_CDESCRI.ToUpper(),
                                  var24 = d.C6_NCANTID,
                                  var241 = ((from t in ctx.AL0003STOC
                                             where t.SK_CALMA == d.C6_CALMA && t.SK_CCODIGO == d.C6_CCODIGO
                                             select new { t.SK_NSKDIS }).FirstOrDefault().SK_NSKDIS),
                                  var25 = ((from t in ctx.AL0003ARTI
                                            where t.AR_CCODIGO == d.C6_CCODIGO
                                            select new { t.AR_CUNIDAD }).FirstOrDefault().AR_CUNIDAD),
                                  var251 = ((from s in ctx.AL0003ASER//ctx.AL0003SERI
                                             where s.C6_CNUMDOC == d.C6_CNUMDOC && s.C6_CTD == d.C6_CTD && s.C6_CALMA == d.C6_CALMA
                                             && s.C6_CITEM == d.C6_CITEM
                                             select new { s.C6_CSERIE }).FirstOrDefault().C6_CSERIE
                                             ),
                                  //where s.SR_CALMA == d.C6_CALMA && s.SR_CCODIGO == d.C6_CCODIGO && s.SR_DFECMOV==d.C6_DFECDOC
                                  //select new { s.SR_CSERIE }).FirstOrDefault().SR_CSERIE),
                                  //select new { s.SR_CSERIE }).FirstOrDefault().SR_CSERIE),
                                  var26 = d.C6_NPREUNI,
                                  var27 = d.C6_NPREUN1,
                                  var28 = d.C6_NMNPRUN,
                                  var29 = d.C6_NUSPRUN

                              }).ToList().Select(c => new Principal()
                              {
                                  C5_CALMA = c.var0,
                                  NOMAL = c.var1,
                                  C5_CTD = c.var2,
                                  C5_CNUMDOC = c.var3,
                                  C5_CLOCALI = c.var4 == null || c.var4 == "" ? "-" : c.var4.Trim(),
                                  C5_DFECDOC = String.Format("{0:dd/MM/yyyy}", c.var5),
                                  C5_CTIPMOV = c.var6,
                                  C5_CCODMOV = c.var7 == null || c.var7.Trim() == "" ? "-" : c.var7.Trim(),
                                  NOMMOV = c.var71,
                                  C5_CRFTDOC = c.var9 == null || c.var9.Trim() == "" ? "-" : c.var9.Trim(),
                                  C5_CSITUA = c.var8,
                                  C5_CRFNDOC = c.var10 == null || c.var10.Trim() == "" ? "-" : c.var10.Trim(),
                                  C5_CRFNDO2 = c.var101 == null || c.var101.Trim() == "" ? "-" : c.var101.Trim(),
                                  C5_CORDEN = c.var102 == null || c.var102.Trim() == "" ? "-" :
                                                ((c.var0 == "A002" || c.var0 == "A004" || c.var0 == "0004" || c.var0 == "0015" || c.var0 == "0009") && c.var102.Trim().Length == 8 ?
                                                tabla_bahias.obtieneBahia(c.var102.Trim()) :
                                                c.var102.Trim()),//c.var102 == null || c.var102.Trim() == "" ? "-" : c.var102.Trim(),
                                  C5_CSOLI = c.var103 == null || c.var103.Trim() == "" ? "-" : c.var103.Trim(),
                                  NOMSOL = c.var1031 == null || c.var1031.Trim() == "" ? "-" : c.var1031.Trim(),
                                  C5_CCENCOS = c.var11 == null || c.var11.Trim() == "" ? "-" : c.var11.Trim(),
                                  NOMCEC = c.var111 == null || c.var111.Trim() == "" ? "-" : c.var111.Trim(),
                                  C5_CRFALMA = c.var12 == null || c.var12.Trim() == "" ? "-" : c.var12.Trim(),
                                  C5_CGLOSA1 = c.var13 == null || c.var13.Trim() == "" ? "-" :
                                                ((c.var0 == "A002" || c.var0 == "A004" || c.var0 == "0004" || c.var0 == "0015" || c.var0 == "0009") && c.var13.Trim().Length <= 12 ?
                                                tabla_embarcaciones.ListarEID(c.var13.Trim()) :
                                                c.var13.Trim()),
                                  C5_CGLOSA2 = c.var14 == null || c.var14.Trim() == "" ? "-" : c.var14.Trim(),
                                  C5_CGLOSA3 = c.var15 == null || c.var15.Trim() == "" ? "-" : c.var15.Trim(),
                                  C5_CGLOSA4 = c.var16 == null || c.var16.Trim() == "" ? "-" : c.var16.Trim(),
                                  C5_CCODPRO = c.var17 == null || c.var17.Trim() == "" ? "-" : c.var17.Trim(),
                                  C5_CNOMPRO = c.var18 == null || c.var18.Trim() == "" ? "-" : c.var18.Trim(),
                                  C5_DFECCRE = String.Format("{0:dd/MM/yyyy}", c.var19),
                                  C5_CUSUCRE = c.var20,
                                  C5_CCODAUT = c.var30,
                                  C5_CNUMORD = c.var201,
                                  C5_CCODMON = c.var202,
                                  C5_CDESTIN = c.var203 == null || c.var203.Trim() == "" ? "-" : c.var203.Trim(),
                                  C5_CCODFER = c.var204 == null || c.var204.Trim() == "" ? "-" : c.var204.Trim(),
                                  C6_CITEM = c.var21,
                                  C6_CCODIGO = c.var22,
                                  C6_CDESCRI = c.var23,
                                  C6_NCANTID = c.var24,
                                  SK_NSKDIS = c.var241,
                                  AR_CUNIDAD = c.var25,
                                  SR_CSERIE = c.var251,
                                  C6_NPREUNI = c.var26,
                                  C6_NPREUN1 = c.var27,
                                  C6_NMNPRUN = c.var28,
                                  C6_NUSPRUN = c.var29

                              }).ToList();
                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND;
        }
        //NUEVO
        public static List<SCabecera> listaCabecera(AL0003MOVC datos)
        {
            //AL0003MOVC datos
            List<SCabecera> listND = new List<SCabecera>();
            try
            {
                int faux1, faux2;
                DateTime f1 = Convert.ToDateTime(datos.C5_DFECDOC);//Convert.ToDateTime(String.Format("{0:MM/dd/yyyy}", datos.C5_DFECDOC));
                faux1 = Convert.ToDateTime(datos.C5_DFECCRE).Year;
                faux2 = Convert.ToDateTime(datos.C5_DFECCRE).Month;

                using (var ctx = new RSFACAR())
                {
                    listND = (from c in ctx.AL0003MOVC
                              where
                              (c.C5_CALMA == datos.C5_CALMA && c.C5_CTD == datos.C5_CTD &&
                                (datos.C5_CNUMDOC == "" ? c.C5_CNUMDOC != "" : c.C5_CNUMDOC == datos.C5_CNUMDOC) &&
                                (datos.C5_DFECCRE != null ? (c.C5_DFECDOC.Value.Year == faux1 && c.C5_DFECDOC.Value.Month == faux2) : (datos.C5_DFECMOD != null ? c.C5_DFECDOC >= datos.C5_DFECDOC && c.C5_DFECMOD <= datos.C5_DFECMOD : c.C5_DFECDOC >= f1 && c.C5_DFECDOC <= f1)) &&
                                (datos.C5_CCODPRO != null ? c.C5_CCODPRO == datos.C5_CCODPRO : c.C5_CCODPRO != datos.C5_CCODPRO) &&
                                (datos.C5_CCODAUT != null ? (datos.C5_CCODAUT == "" ? c.C5_CCODAUT == datos.C5_CCODAUT : c.C5_CCODAUT != datos.C5_CCODAUT) : c.C5_CCODAUT != null) &&
                                c.C5_CCODMOV != "AI"
                              )
                              orderby c.C5_CNUMDOC ascending
                              select new
                              {
                                  var0 = c.C5_CALMA,
                                  var1 = ((from t1 in ctx.AL0003ALMA
                                           where t1.A1_CALMA == c.C5_CALMA
                                           select new { t1.A1_CDESCRI }).FirstOrDefault().A1_CDESCRI),
                                  var2 = c.C5_CTD,
                                  var3 = c.C5_CNUMDOC,
                                  var4 = c.C5_CLOCALI,
                                  var5 = c.C5_DFECDOC,
                                  var6 = c.C5_CTIPMOV,
                                  var7 = c.C5_CCODMOV,
                                  var71 = ((from t2 in ctx.AL0003TABM
                                            where t2.TM_CCODMOV == c.C5_CCODMOV
                                            select new { t2.TM_CDESCRI }).FirstOrDefault().TM_CDESCRI),
                                  var8 = c.C5_CSITUA,
                                  var9 = c.C5_CRFTDOC,
                                  var91 = ((from t3 in ctx.AL0003TABL
                                            where (t3.TG_CCLAVE == c.C5_CRFTDOC && t3.TG_CCOD == "04")
                                            select new { t3.TG_CDESCRI }).FirstOrDefault().TG_CDESCRI),
                                  var10 = c.C5_CRFNDOC,
                                  var100 = c.C5_CRFNDO2,
                                  var101 = c.C5_CSOLI,
                                  var1010 = ((from t4 in ctx.AL0003TABL
                                              where (t4.TG_CCLAVE.Trim() == c.C5_CSOLI.Trim() && t4.TG_CCOD == "12")
                                              select new { t4.TG_CDESCRI }).FirstOrDefault().TG_CDESCRI),
                                  var11 = c.C5_CCENCOS,
                                  var111 = ((from t5 in ctx.AL0003TABL
                                             where (t5.TG_CCLAVE.Trim() == c.C5_CCENCOS.Trim() && t5.TG_CCOD == "10")
                                             select new { t5.TG_CDESCRI }).FirstOrDefault().TG_CDESCRI),
                                  var12 = c.C5_CRFALMA,
                                  var13 = c.C5_CGLOSA1,
                                  var14 = c.C5_CGLOSA2,
                                  var15 = c.C5_CGLOSA3,
                                  var16 = c.C5_CGLOSA4,
                                  var17 = c.C5_CCODPRO,
                                  var18 = c.C5_CNOMPRO,
                                  var181 = c.C5_CORDEN,
                                  var19 = c.C5_DFECCRE,
                                  var20 = c.C5_CUSUCRE,
                                  var201 = c.C5_CNUMORD,
                                  var202 = c.C5_CCODMON,
                                  var203 = c.C5_CDESTIN,
                                  var204 = c.C5_CCODFER,
                                  var21 = c.C5_NTIPCAM,
                                  var22 = c.C5_CSUBDIA,
                                  var23 = c.C5_CCOMPRO,
                                  var24 = c.C5_CSBNOM,
                                  var25 = c.C5_CLICCON,
                                  var26 = c.C5_CCODAUT,
                                  var27 = c.C5_DFECEMB
                              }).ToList().Select(c => new SCabecera()
                              {
                                  C5_CALMA = c.var0,
                                  NOMAL = c.var1,
                                  C5_CTD = c.var2,
                                  C5_CNUMDOC = c.var3,
                                  C5_CLOCALI = c.var4 == null || c.var4 == "" ? "-" : c.var4.Trim(),
                                  C5_DFECDOC = String.Format("{0:dd/MM/yyyy}", c.var5),
                                  C5_CTIPMOV = c.var6,
                                  C5_CCODMOV = c.var7 == null || c.var7.Trim() == "" ? "-" : c.var7.Trim(),
                                  NOMMOV = c.var71,
                                  C5_CRFTDOC = c.var9 == null || c.var9.Trim() == "" ? "-" : c.var9.Trim(),
                                  NOMDR = c.var91,
                                  C5_CSITUA = c.var8,
                                  C5_CRFNDOC = c.var10 == null || c.var10.Trim() == "" ? "-" : c.var10.Trim(),
                                  C5_CRFNDO2 = c.var100 == null || c.var100.Trim() == "" ? "-" : c.var100.Trim(),
                                  C5_CSOLI = c.var101 == null || c.var101.Trim() == "" ? "-" : c.var101.Trim(),
                                  NOMSOL = c.var1010 == null || c.var1010.Trim() == "" ? "-" : c.var1010.Trim(),
                                  C5_CCENCOS = c.var11 == null || c.var11.Trim() == "" ? "-" : c.var11.Trim(),
                                  NOMCC = c.var111 == null || c.var111.Trim() == "" ? "-" : c.var111.Trim(),
                                  C5_CRFALMA = c.var12 == null || c.var12.Trim() == "" ? "-" : c.var12.Trim(),
                                  C5_CGLOSA1 = c.var13 == null || c.var13.Trim() == "" ? "-" :
                                                 ((c.var0 == "A002" || c.var0 == "A004" || c.var0 == "0004" || c.var0 == "0009") && (c.var13.Trim().Length >= 10 && c.var13.Trim().Length <= 11) ?
                                                tabla_embarcaciones.ListarEID(c.var13.Trim()) :
                                                c.var13.Trim()),
                                  C5_CGLOSA2 = c.var14 == null || c.var14.Trim() == "" ? "-" : c.var14.Trim(),
                                  C5_CGLOSA3 = c.var15 == null || c.var15.Trim() == "" ? "-" : c.var15.Trim(),
                                  C5_CGLOSA4 = c.var16 == null || c.var18.Trim() == "" ? "-" : c.var16.Trim(),
                                  C5_CCODPRO = c.var17 == null || c.var17.Trim() == "" ? "-" : c.var17.Trim(),
                                  C5_CNOMPRO = c.var18 == null || c.var18.Trim() == "" ? "-" : c.var18.Trim(),
                                  C5_CORDEN = c.var181 == null || c.var181.Trim() == "" ? "-" : c.var181.Trim(),
                                  NOMBAH = (c.var181.Trim().Length == 8 ? tabla_bahias.obtieneBahia(c.var181) : "-"),
                                  C5_DFECCRE = String.Format("{0:dd/MM/yyyy}", c.var19),
                                  C5_CUSUCRE = c.var20,
                                  C5_CNUMORD = c.var201 == null || c.var201.Trim() == "" ? "" : c.var201.Trim(),
                                  C5_CCODMON = c.var202 == null || c.var202.Trim() == "" ? "-" : c.var202.Trim(),
                                  C5_CDESTIN = c.var203 == null || c.var203.Trim() == "" ? "-" : c.var203.Trim(),
                                  C5_CCODFER = c.var204 == null || c.var204.Trim() == "" ? "" : c.var204.Trim(),
                                  C5_NTIPCAM = c.var21,
                                  C5_CSUBDIA = c.var22 == null || c.var22.Trim() == "" ? "" : c.var22.Trim(),
                                  C5_CCOMPRO = c.var23 == null || c.var23.Trim() == "" ? "" : c.var23.Trim(),
                                  C5_CSBNOM = c.var24,
                                  C5_CLICCON = c.var25,
                                  C5_CCODAUT = c.var26,
                                  C5_DFECEMB = String.Format("{0:dd/MM/yyyy}", c.var27)
                              }).ToList();
                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND;
        }

        /// <summary>
        /// Liquidacion de Compra detalle
        /// Actualizacion:26.04.2016
        /// Nota:Valida que sea n items, con orden compra aprobada
        /// </summary>
        /// <param name="PDATA"></param>
        /// <returns></returns>
        public static List<SCabecera> listaCabeceraD(AL0003MOVC PDATA, string[] ND)
        {
            List<SCabecera> listND1 = new List<SCabecera>();
            try
            {
                using (var ctx = new RSFACAR())
                {

                    listND1 = (from c in ctx.AL0003MOVC
                               join d in ctx.AL0003MOVD
                                   on new { c.C5_CALMA, c.C5_CTD, c.C5_CNUMDOC }
                               equals new { C5_CALMA = d.C6_CALMA, C5_CTD = d.C6_CTD, C5_CNUMDOC = d.C6_CNUMDOC }
                               where
                               (c.C5_CALMA == PDATA.C5_CALMA && c.C5_CTD == PDATA.C5_CTD &&
                                 (ND).Contains(c.C5_CNUMDOC) &&
                                 //(PDATA.C5_CNUMDOC != null ? (miarray).Contains(c.C5_CNUMDOC) : c.C5_CNUMDOC != PDATA.C5_CNUMDOC) &&
                                 (PDATA.C5_CCODMOV != null ? c.C5_CCODMOV == PDATA.C5_CCODMOV : c.C5_CCODMOV != PDATA.C5_CCODMOV) &&
                                 (PDATA.C5_CRFTDOC != null ? c.C5_CRFTDOC != PDATA.C5_CRFTDOC : c.C5_CRFTDOC == PDATA.C5_CRFTDOC) &&
                                 (PDATA.C5_CCODPRO != null ? c.C5_CCODPRO == PDATA.C5_CCODPRO : c.C5_CCODPRO != PDATA.C5_CCODPRO) &&
                                 //(PDATA.C5_CNUMORD != null ? c.C5_CNUMORD == PDATA.C5_CNUMORD : c.C5_CNUMORD != PDATA.C5_CNUMORD) &&
                                 (c.C5_CSITUA == "V") && //NO ESTEN VALORIZADOS
                                 (c.C5_DFECDOC >= PDATA.C5_DFECDOC && c.C5_DFECDOC <= PDATA.C5_DFECMOD)
                               )
                               orderby c.C5_CNUMDOC ascending
                               group new { c, d } by new
                               {
                                   /*SI QUITO NUMERO DOCUMENTO ES RESUMIDO*/
                                   //c.C5_CNUMDOC,
                                   c.C5_CCODPRO,
                                   d.C6_CITEM,
                                   d.C6_CCODIGO,
                                   d.C6_CDESCRI,
                                   d.C6_NPREUNI,
                                   d.C6_NPREUN1,
                                   d.C6_NMNPRUN,
                                   d.C6_CCODMON //NUEVO
                                   //,d.C6_NUSPRUN
                               } into g
                               select new
                               {
                                   //var3 = g.Key.C5_CNUMDOC,
                                   var17 = g.Key.C5_CCODPRO,
                                   var18 = g.Key.C6_CITEM,
                                   var19 = g.Key.C6_CCODIGO,
                                   var21 = g.Key.C6_CDESCRI,
                                   var22 = (decimal)g.Sum(p => p.d.C6_NCANTID),
                                   var25 = ((from t in ctx.AL0003ARTI
                                             where t.AR_CCODIGO == g.Key.C6_CCODIGO
                                             select new { t.AR_CUNIDAD }).FirstOrDefault().AR_CUNIDAD),
                                   var26 = g.Key.C6_NPREUNI,
                                   var27 = g.Key.C6_NPREUN1,
                                   var28 = g.Key.C6_NMNPRUN,
                                   var29 = g.Key.C6_CCODMON//NUEVO 

                               }).ToList().Select(c => new SCabecera()
                               {
                                   //C5_CNUMDOC = c.var3,
                                   C5_CCODPRO = c.var17 == null || c.var17.Trim() == "" ? "-" : c.var17.Trim(),
                                   C6_CITEM = c.var18,
                                   C6_CCODIGO = c.var19,
                                   C6_CDESCRI = c.var21,
                                   C6_NCANTID = c.var22,
                                   AR_CUNIDAD = c.var25,
                                   C6_NPREUNI = c.var26,
                                   C6_NPREUN1 = c.var27,
                                   C6_NMNPRUN = c.var28,
                                   C6_CCODMON = c.var29//NUEVO MONEDA
                                   //,C6_NUSPRUN = c.var29
                               }).ToList();

                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND1;
        }

        /// <summary>
        /// Contabilizacion Documentos O/C
        /// Actualizacion:26.04.2016
        /// Nota:Valida que sea n items, con orden compra aprobada
        /// </summary>
        /// <param name="PDATA"></param>
        /// <returns></returns>
        public static List<SCabecera> listaCabeceraDX(AL0003MOVC PDATA, string[] ND)
        {
            List<SCabecera> listND1 = new List<SCabecera>();
            try
            {
                using (var ctx = new RSFACAR())
                {

                    listND1 = (from c in ctx.AL0003MOVC
                               join d in ctx.AL0003MOVD
                                   on new { c.C5_CALMA, c.C5_CTD, c.C5_CNUMDOC }
                               equals new { C5_CALMA = d.C6_CALMA, C5_CTD = d.C6_CTD, C5_CNUMDOC = d.C6_CNUMDOC }
                               join a in ctx.AL0003ARTI
                                   on new { d.C6_CCODIGO }
                               equals new { C6_CCODIGO = a.AR_CCODIGO }
                               /*join e in ctx.FT0003CTAE
                                   on new { a.AR_CCUENTA }
                                   equals new { AR_CCUENTA = e.TC_CEXISTE }*/
                               where
                               (c.C5_CALMA == PDATA.C5_CALMA && c.C5_CTD == PDATA.C5_CTD &&
                                 (ND).Contains(c.C5_CNUMDOC) &&
                                 //(PDATA.C5_CNUMDOC != null ? (miarray).Contains(c.C5_CNUMDOC) : c.C5_CNUMDOC != PDATA.C5_CNUMDOC) &&
                                 (PDATA.C5_CCODMOV != null ? c.C5_CCODMOV == PDATA.C5_CCODMOV : c.C5_CCODMOV != PDATA.C5_CCODMOV) &&
                                 (PDATA.C5_CRFTDOC != null ? c.C5_CRFTDOC != PDATA.C5_CRFTDOC : c.C5_CRFTDOC == PDATA.C5_CRFTDOC) &&
                                 (PDATA.C5_CCODPRO != null ? c.C5_CCODPRO == PDATA.C5_CCODPRO : c.C5_CCODPRO != PDATA.C5_CCODPRO) &&
                                 //(PDATA.C5_CNUMORD != null ? c.C5_CNUMORD == PDATA.C5_CNUMORD : c.C5_CNUMORD != PDATA.C5_CNUMORD) &&
                                 (c.C5_CSITUA == "V") && //NO ESTEN VALORIZADOS
                                 (c.C5_DFECDOC >= PDATA.C5_DFECDOC && c.C5_DFECDOC <= PDATA.C5_DFECMOD)
                               )
                               orderby c.C5_CNUMDOC ascending
                               group new { c, d, a } by new//group new { c, d, a, e } by new
                               {
                                   /*SI QUITO NUMERO DOCUMENTO ES RESUMIDO*/
                                   /*c.C5_CNUMDOC,*/
                                   c.C5_CCODPRO,
                                   d.C6_CITEM,
                                   d.C6_CCODIGO,
                                   d.C6_CDESCRI,
                                   d.C6_NPREUNI,
                                   d.C6_NPREUN1,
                                   d.C6_NMNPRUN,
                                   d.C6_CCODMON, //NUEVO
                                   a.AR_CCUENTA
                                   /*e.TC_CCOMPRA*/
                                   //,d.C6_NUSPRUN
                               } into g
                               select new
                               {
                                   /*var3 = g.Key.C5_CNUMDOC,*/
                                   var17 = g.Key.C5_CCODPRO,
                                   var18 = g.Key.C6_CITEM,
                                   var19 = g.Key.C6_CCODIGO,
                                   var21 = g.Key.C6_CDESCRI,
                                   var22 = (decimal)g.Sum(p => p.d.C6_NCANTID),
                                   var25 = ((from t in ctx.AL0003ARTI
                                             where t.AR_CCODIGO == g.Key.C6_CCODIGO
                                             select new { t.AR_CUNIDAD }).FirstOrDefault().AR_CUNIDAD),
                                   var26 = g.Key.C6_NPREUNI,
                                   var27 = g.Key.C6_NPREUN1,
                                   var28 = g.Key.C6_NMNPRUN,
                                   var29 = g.Key.C6_CCODMON,//NUEVO 
                                   var30 = g.Key.AR_CCUENTA,
                                   var31 = ((from t in ctx.FT0003CTAE
                                             where t.TC_CEXISTE == g.Key.AR_CCUENTA
                                             select new { t.TC_CCOMPRA }).FirstOrDefault().TC_CCOMPRA),
                                   /*g.Key.TC_CCOMPRA*/
                                   var32 = ((from t in ctx.FT0003CTAE
                                             where t.TC_CEXISTE == g.Key.AR_CCUENTA
                                             select new { t.TC_CDESCRI }).FirstOrDefault().TC_CDESCRI)
                               }).ToList().Select(c => new SCabecera()
                               {
                                   /*C5_CNUMDOC = c.var3,*/
                                   C5_CCODPRO = c.var17 == null || c.var17.Trim() == "" ? "-" : c.var17.Trim(),
                                   C6_CITEM = c.var18,
                                   C6_CCODIGO = c.var19.Trim(),
                                   C6_CDESCRI = c.var21,
                                   C6_NCANTID = c.var22,
                                   AR_CUNIDAD = c.var25,
                                   C6_NPREUNI = c.var26,
                                   C6_NPREUN1 = c.var27,
                                   C6_NMNPRUN = c.var28,
                                   C6_CCODMON = c.var29,//NUEVO MONEDA
                                   AR_CCUENTA = c.var30.Trim(),
                                   TC_CCOMPRA = (c.var31 != null && c.var31 != "" ? c.var31.Trim() : "-"),
                                   TC_CDESCRI = (c.var32 != null && c.var32 != "" ? c.var32.Trim() : "No existe la cuenta de existencia")
                                   //,C6_NUSPRUN = c.var29
                               }).ToList();

                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND1;
        }
        /// <summary>
        /// NUEVO PE CANTIDA -CDOC
        /// </summary>
        /// <param name="PDATA"></param>
        /// <returns></returns>
        public static List<SCabecera> listaCabeceraDX1(AL0003MOVC PDATA, string[] ND)
        {
            List<SCabecera> listND1 = new List<SCabecera>();
            try
            {
                using (var ctx = new RSFACAR())
                {

                    listND1 = (from c in ctx.AL0003MOVC
                               join d in ctx.AL0003MOVD
                               on new { c.C5_CALMA, c.C5_CTD, c.C5_CNUMDOC }
                               equals new { C5_CALMA = d.C6_CALMA, C5_CTD = d.C6_CTD, C5_CNUMDOC = d.C6_CNUMDOC }
                               join oc in ctx.CO0003MOVC
                                  on new { c.C5_CNUMORD }
                                  equals new { C5_CNUMORD = oc.OC_CNUMORD }
                               where
                               (c.C5_CALMA == PDATA.C5_CALMA && c.C5_CTD == PDATA.C5_CTD &&
                                 (ND).Contains(c.C5_CNUMDOC) &&
                                 (PDATA.C5_CCODMOV != null ? c.C5_CCODMOV == PDATA.C5_CCODMOV : c.C5_CCODMOV != PDATA.C5_CCODMOV) &&
                                 (PDATA.C5_CRFTDOC != null ? c.C5_CRFTDOC != PDATA.C5_CRFTDOC : c.C5_CRFTDOC == PDATA.C5_CRFTDOC) &&
                                 (PDATA.C5_CCODPRO != null ? c.C5_CCODPRO == PDATA.C5_CCODPRO : c.C5_CCODPRO != PDATA.C5_CCODPRO) &&
                                 (PDATA.C5_CNUMORD != null ? c.C5_CNUMORD == PDATA.C5_CNUMORD : c.C5_CNUMORD != PDATA.C5_CNUMORD) &&
                                 (c.C5_CSITUA == "V") && //NO ESTEN VALORIZADOS:M
                                                         //(c.C5_DFECDOC >= PDATA.C5_DFECDOC && c.C5_DFECDOC <= PDATA.C5_DFECMOD) &&
                                                         //(PDATA.C5_CTIPORD != null ? c.C5_CTIPORD != PDATA.C5_CTIPORD : c.C5_CTIPORD == PDATA.C5_CTIPORD) &&
                                 (new string[] { "4", "5" }).Contains(oc.OC_CSITORD)//R.TOTAL Y PARCIAL
                               )
                               orderby c.C5_CNUMDOC ascending
                               group new { c, d } by new
                               {
                                   c.C5_CALMA,
                                   //c.C5_CTD,
                                   c.C5_CNUMDOC,
                                   c.C5_CCODMON,//MONEDA
                                   c.C5_CCODPRO,
                                   c.C5_CNOMPRO,
                                   oc.OC_CNUMORD
                                   //c.C5_CALMA,
                                   //c.C5_CTD,
                                   //d.C6_CCODIGO
                               } into g
                               select new
                               {
                                   var0 = g.Key.C5_CALMA,
                                   var1 = ((from t1 in ctx.AL0003ALMA
                                            where t1.A1_CALMA == g.Key.C5_CALMA
                                            select new { t1.A1_CDESCRI }).FirstOrDefault().A1_CDESCRI),
                                   //AGREGADO 22.07.16
                                   var3 = g.Key.C5_CNUMDOC,
                                   //var5 = g.Key.C5_DFECDOC,
                                   var17 = g.Key.C5_CCODPRO,
                                   var18 = g.Key.C5_CNOMPRO,
                                   //var19 = g.Key.C6_CCODIGO,
                                   //var21 = ((from t2 in ctx.AL0003MOVD
                                   //          where t2.C6_CALMA == g.Key.C5_CALMA && t2.C6_CTD == g.Key.C5_CTD && t2.C6_CNUMDOC == g.Key.C5_CNUMDOC
                                   //          select new { t2.C6_CCODIGO }).FirstOrDefault().C6_CCODIGO.Substring(0, 2)),
                                   var22 = (decimal)g.Sum(p => p.d.C6_NCANTID * (g.Key.C5_CCODMON == "MN" ? p.d.C6_NPREUN1 : p.d.C6_NPREUNI)),//C6_NPREUNI ->DOLARES
                                   var23 = g.Key.OC_CNUMORD
                               }).ToList().Select(c => new SCabecera()
                               {
                                   C5_CALMA = c.var0,
                                   NOMAL = c.var1,
                                   //C5_CTD = c.var2,
                                   C5_CNUMDOC = c.var3,
                                   //C5_DFECDOC = String.Format("{0:dd/MM/yyyy}", c.var5),
                                   //C5_CSITUA = c.var8,
                                   C5_CCODPRO = c.var17 == null || c.var17.Trim() == "" ? "-" : c.var17.Trim(),
                                   C5_CNOMPRO = c.var18 == null || c.var18.Trim() == "" ? "-" : c.var18.Trim(),
                                   //C5_DFECCRE = String.Format("{0:dd/MM/yyyy}", c.var19),
                                   //C6_CCODIGO = c.var21,
                                   //C6_CDESCRI = tabla_parametros.ListarParametroID("ES", c.var21),
                                   C6_NCANTID = c.var22,
                                   C5_CNUMORD = c.var23
                               }).ToList();

                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND1;
        }

        /// <summary>
        /// Consulta CUENTA COMPRA x EXISTENCIA
        /// Uso: Contabilizacin de Documentos O/C
        /// Creacin: 01.06.16
        /// Modificacin:--.--.--
        /// </summary>
        /// <param name="PDATA"></param>
        /// <param name="ND"></param>
        /// <returns></returns>
        public static List<SCabecera> listaCCE(AL0003MOVC PDATA, string[] ND)
        {
            List<SCabecera> listND1 = new List<SCabecera>();
            try
            {
                using (var ctx = new RSFACAR())
                {

                    listND1 = (from c in ctx.AL0003MOVC
                               join d in ctx.AL0003MOVD
                                   on new { c.C5_CALMA, c.C5_CTD, c.C5_CNUMDOC }
                               equals new { C5_CALMA = d.C6_CALMA, C5_CTD = d.C6_CTD, C5_CNUMDOC = d.C6_CNUMDOC }
                               join a in ctx.AL0003ARTI
                                   on new { d.C6_CCODIGO }
                               equals new { C6_CCODIGO = a.AR_CCODIGO.Trim() }
                               join e in ctx.FT0003CTAE
                                   on new { a.AR_CCUENTA }
                                   equals new { AR_CCUENTA = e.TC_CEXISTE.Trim() }
                               where
                                 ((ND).Contains(c.C5_CNUMDOC) &&
                                 (PDATA.C5_CCODMOV != null ? c.C5_CCODMOV.Trim() == PDATA.C5_CCODMOV.Trim() : c.C5_CCODMOV != PDATA.C5_CCODMOV) &&
                                 (PDATA.C5_CCODPRO != null ? c.C5_CCODPRO.Trim() == PDATA.C5_CCODPRO.Trim() : c.C5_CCODPRO != PDATA.C5_CCODPRO) &&
                                 (PDATA.C5_CNUMORD != null ? c.C5_CNUMORD.Trim() == PDATA.C5_CNUMORD.Trim() : c.C5_CNUMORD != PDATA.C5_CNUMORD) &&
                                 (c.C5_CSITUA == "V") //NO ESTEN VALORIZADOS
                               )
                               orderby e.TC_CCOMPRA ascending
                               //group new { c, d, a, e } by new
                               group new { e, d } by new
                               {
                                   /*SI QUITO NUMERO DOCUMENTO ES RESUMIDO*/
                                   //c.C5_CNUMDOC,8
                                   //c.C5_CCODPRO,
                                   //d.C6_CITEM,
                                   //d.C6_CCODIGO,
                                   //d.C6_CDESCRI,
                                   e.TC_CCOMPRA,
                                   //d.C6_NPREUNI,
                                   //d.C6_NCANTID,
                                   //d.C6_NPREUN1,
                                   //d.C6_NMNPRUN,
                                   //d.C6_CCODMON, //NUEVO
                                   //a.AR_CCUENTA,
                                   //,d.C6_NUSPRUN
                               } into g
                               select new
                               {
                                   //var3 = g.Key.C5_CNUMDOC,
                                   //var17 = g.Key.C5_CCODPRO,
                                   //var18 = g.Key.C6_CITEM,
                                   //var19 = g.Key.C6_CCODIGO,
                                   //var21 = g.Key.C6_CDESCRI,
                                   var20 = g.Key.TC_CCOMPRA,
                                   var22 = (decimal)g.Sum(p => p.d.C6_NCANTID * p.d.C6_NPREUNI)//p=>p.d.C6_NCANTID*p.d.C6_NPREUNI),
                                   /*var25 = ((from t in ctx.AL0003ARTI
                                             where t.AR_CCODIGO == g.Key.C6_CCODIGO
                                             select new { t.AR_CUNIDAD }).FirstOrDefault().AR_CUNIDAD),*/
                                   //var26 = g.Key.C6_NPREUNI,
                                   //var27 = g.Key.C6_NPREUN1,
                                   //var28 = g.Key.C6_NMNPRUN,
                                   //var29 = g.Key.C6_CCODMON,//NUEVO 
                                   //var30 = g.Key.AR_CCUENTA,
                                   //var31 = g.Key.TC_CCOMPRA
                               }).ToList().Select(c => new SCabecera()
                               {
                                   //C5_CNUMDOC = c.var3,
                                   //C5_CCODPRO = c.var17 == null || c.var17.Trim() == "" ? "-" : c.var17.Trim(),
                                   //C6_CITEM = c.var18,
                                   //C6_CCODIGO = c.var19.Trim(),
                                   //C6_CDESCRI = c.var21,
                                   TC_CCOMPRA = c.var20.Trim(),
                                   C6_NCANTID = c.var22
                                   //AR_CUNIDAD = c.var25,
                                   //C6_NPREUNI = c.var26
                                   //C6_NPREUN1 = c.var27,
                                   //C6_NMNPRUN = c.var28,
                                   //C6_CCODMON = c.var29,//NUEVO MONEDA
                                   //AR_CCUENTA = c.var30.Trim(),
                                   //TC_CCOMPRA = c.var31.Trim()
                                   //,C6_NUSPRUN = c.var29
                               }).ToList();

                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND1;
        }
        /// <summary>
        /// Valoriza Parte de Entrada Cambio/Tipo
        /// Actualizacion 09/05/2016
        /// </summary>
        /// <param name="VDATA"></param>
        /// <returns></returns>
        public static Boolean valorizaCabecera(AL0003MOVC VDATA)
        {   //VALORIZA PARTES MANUALES - LIQUIDACIONES
            Boolean band = true;
            var fechaA = DateTime.Now;
            var data = new AL0003MOVC { C5_CALMA = VDATA.C5_CALMA, C5_CTD = VDATA.C5_CTD, C5_CNUMDOC = VDATA.C5_CNUMDOC };
            try
            {
                using (var ctx = new RSFACAR())
                {
                    ctx.AL0003MOVC.Attach(data);
                    data.C5_CSITUA = "V";//VALORIZADO
                    //data.C5_CRFTDOC = VDATA.C5_CRFTDOC;
                    //data.C5_CRFNDOC = VDATA.C5_CRFNDOC;
                    data.C5_CGUIFAC = VDATA.C5_CGUIFAC;//LQ
                    data.C5_CCODPRO = VDATA.C5_CCODPRO;
                    data.C5_CNOMPRO = VDATA.C5_CNOMPRO;
                    data.C5_CCODMON = VDATA.C5_CCODMON;
                    data.C5_NTIPCAM = VDATA.C5_NTIPCAM;
                    data.C5_CTIPO = VDATA.C5_CTIPO;//TIPO DE CAMBIO VENTA/NACIONAL
                    data.C5_CSUBDIA = VDATA.C5_CSUBDIA;
                    data.C5_CCOMPRO = VDATA.C5_CCOMPRO;
                    data.C5_CNUMORD = VDATA.C5_CNUMORD;
                    data.C5_CSBNOM = VDATA.C5_CSBNOM;//IGV
                    data.C5_CLICCON = VDATA.C5_CLICCON;//ORDEN DE SERVICIO
                    data.C5_DFECMOD = fechaA;
                    data.C5_CUSUMOD = VDATA.C5_CUSUMOD;
                    ctx.Configuration.ValidateOnSaveEnabled = false;
                    ctx.SaveChanges();

                }
            }
            catch (DbEntityValidationException dbEx)
            {
                foreach (var validationErrors in dbEx.EntityValidationErrors)
                {
                    foreach (var validationError in validationErrors.ValidationErrors)
                    {
                        Trace.TraceInformation("Property: {0} Error: {1}", validationError.PropertyName, validationError.ErrorMessage);
                    }
                }
                band = false;
            }
            return band;
        }

        /// <summary>
        /// Valoriza PE Y FINALIZA ORDEN COMPRA - PROVISION MCIME
        /// </summary>
        /// <param name="VDATA"></param>
        /// <returns></returns>
        public static Boolean valorizaCabeceraG(AL0003MOVC VDATA)
        {   //VALORIZA PARTES MANUALES - LIQUIDACIONES
            Boolean band = true;
            //int COUNT = 0;
            var fechaA = DateTime.Now;
            var data = new AL0003MOVC { C5_CALMA = VDATA.C5_CALMA, C5_CTD = VDATA.C5_CTD, C5_CNUMDOC = VDATA.C5_CNUMDOC };
            //var ORDEN = new CO0003MOVC { OC_CNUMORD=VDATA.C5_CNUMORD };

            try
            {
                using (var ctx = new RSFACAR())
                {
                    ctx.AL0003MOVC.Attach(data);
                    data.C5_CSITUA = "V";//VALORIZADO
                    data.C5_CRFTDOC = VDATA.C5_CRFTDOC;//LQ|FT
                    data.C5_CRFNDOC = VDATA.C5_CRFNDOC;//CORRELATIVO
                    data.C5_CGUIFAC = VDATA.C5_CGUIFAC;
                    data.C5_CTIPORD = VDATA.C5_CTIPORD;
                    //data.C5_CCODPRO = VDATA.C5_CCODPRO;
                    //data.C5_CNOMPRO = VDATA.C5_CNOMPRO;
                    //data.C5_CCODMON = VDATA.C5_CCODMON;
                    //data.C5_NTIPCAM = VDATA.C5_NTIPCAM;
                    //data.C5_CTIPO = VDATA.C5_CTIPO;//TIPO DE CAMBIO VENTA/NACIONAL
                    data.C5_CSUBDIA = VDATA.C5_CSUBDIA;
                    data.C5_CCOMPRO = VDATA.C5_CCOMPRO;
                    //data.C5_DFECMOD = fechaA;
                    //data.C5_CUSUMOD = VDATA.C5_CUSUMOD;
                    //ACTUALIZA ESTADO ORDEN
                    var miupdate = ctx.CO0003MOVC.Where(u => u.OC_CCOTIZA == VDATA.C5_CNUMDOC).ToList();
                    miupdate.ForEach(mdata =>
                    {
                        //ACTUALIZACION 07.06.15 -CONTABILIZACION DOCUMENTOS O/C
                        if (VDATA.C5_CNUMPED != null)
                        {
                            var ORDEN = new CO0003MOVC { OC_CNUMORD = mdata.OC_CNUMORD };
                            ORDEN.OC_CSITORD = VDATA.C5_CNUMPED;//LIQUIDADA
                            CO0003MOVC.EstadoOC(ORDEN);

                            CO0003MOVD OA = new CO0003MOVD();
                            OA.OC_CNUMORD = mdata.OC_CNUMORD;
                            OA.OC_CCODPRO = mdata.OC_CCODPRO;
                            OA.OC_CESTADO = VDATA.C5_CNUMPED;//DEACUERDO A LO QUE VIENE

                            CO0003MOVD.actualizaDetalleO(OA);

                        }
                        else
                        {
                            var ORDEN = new CO0003MOVC { OC_CNUMORD = mdata.OC_CNUMORD };
                            ORDEN.OC_CSITORD = "8";//"6";//LIQUIDADA
                            CO0003MOVC.EstadoOC(ORDEN);

                            CO0003MOVD OA = new CO0003MOVD();
                            OA.OC_CNUMORD = mdata.OC_CNUMORD;
                            OA.OC_CCODPRO = mdata.OC_CCODPRO;
                            OA.OC_CESTADO = "8";//"6";//LIQUIDADA

                            CO0003MOVD.actualizaDetalleO(OA);
                        }



                    });



                    ctx.Configuration.ValidateOnSaveEnabled = false;
                    ctx.SaveChanges();

                }
            }
            catch (DbEntityValidationException dbEx)
            {
                foreach (var validationErrors in dbEx.EntityValidationErrors)
                {
                    foreach (var validationError in validationErrors.ValidationErrors)
                    {
                        Trace.TraceInformation("Property: {0} Error: {1}", validationError.PropertyName, validationError.ErrorMessage);
                    }
                }
                band = false;
            }
            return band;
        }

        /// <summary>
        /// Lista PE que tiene OC aprobadas
        /// Actualizacion:29.04.2016
        /// </summary>
        /// <param name="PDATA"></param>
        /// <returns></returns>
        public static List<SCabecera> listaCabeceraI(AL0003MOVC PDATA)
        {
            List<SCabecera> listND1 = new List<SCabecera>();
            try
            {
                using (var ctx = new RSFACAR())
                {

                    listND1 = (from c in ctx.AL0003MOVC
                               join d in ctx.AL0003MOVD
                               on new { c.C5_CALMA, c.C5_CTD, c.C5_CNUMDOC }
                               equals new { C5_CALMA = d.C6_CALMA, C5_CTD = d.C6_CTD, C5_CNUMDOC = d.C6_CNUMDOC }
                               join oc in ctx.CO0003MOVC
                                  on new { c.C5_CNUMORD }
                                  equals new { C5_CNUMORD = oc.OC_CNUMORD }
                               where
                               (c.C5_CALMA == PDATA.C5_CALMA && c.C5_CTD == PDATA.C5_CTD &&
                                 (PDATA.C5_CNUMDOC != null ? c.C5_CNUMDOC == PDATA.C5_CNUMDOC : c.C5_CNUMDOC != PDATA.C5_CNUMDOC) &&
                                 (PDATA.C5_CCODMOV != null ? c.C5_CCODMOV == PDATA.C5_CCODMOV : c.C5_CCODMOV != PDATA.C5_CCODMOV) &&
                                 (PDATA.C5_CRFTDOC != null ? c.C5_CRFTDOC != PDATA.C5_CRFTDOC : c.C5_CRFTDOC == PDATA.C5_CRFTDOC) &&
                                 (PDATA.C5_CCODMON != null ? c.C5_CCODMON == PDATA.C5_CCODMON : c.C5_CCODMON != PDATA.C5_CCODMON) &&
                                 (PDATA.C5_CCODPRO != null ? c.C5_CCODPRO == PDATA.C5_CCODPRO : c.C5_CCODPRO != PDATA.C5_CCODPRO) &&
                                 (PDATA.C5_CNUMORD != null ? c.C5_CNUMORD == PDATA.C5_CNUMORD : c.C5_CNUMORD != PDATA.C5_CNUMORD) &&
                                 (c.C5_CSITUA == "V") && //NO ESTEN VALORIZADOS:M
                                 (c.C5_DFECDOC >= PDATA.C5_DFECDOC && c.C5_DFECDOC <= PDATA.C5_DFECMOD) &&
                                 (PDATA.C5_CTIPORD != null ? c.C5_CTIPORD != PDATA.C5_CTIPORD : c.C5_CTIPORD == PDATA.C5_CTIPORD) &&
                                 (oc.OC_CSITORD == "2")//APROBADOS
                               )
                               orderby c.C5_CNUMDOC ascending
                               group new { c, d } by new
                               {
                                   c.C5_CALMA,
                                   c.C5_CTD,
                                   c.C5_CNUMDOC,
                                   c.C5_DFECDOC,
                                   c.C5_CCODPRO,
                                   c.C5_CNOMPRO,
                                   oc.OC_CNUMORD
                                   //c.C5_CALMA,
                                   //c.C5_CTD,
                                   //d.C6_CCODIGO
                               } into g
                               select new
                               {
                                   var0 = g.Key.C5_CALMA,
                                   var1 = ((from t1 in ctx.AL0003ALMA
                                            where t1.A1_CALMA == g.Key.C5_CALMA
                                            select new { t1.A1_CDESCRI }).FirstOrDefault().A1_CDESCRI),
                                   //var2 = g.Key.C5_CTD,
                                   var3 = g.Key.C5_CNUMDOC,
                                   var5 = g.Key.C5_DFECDOC,
                                   var17 = g.Key.C5_CCODPRO,
                                   var18 = g.Key.C5_CNOMPRO,
                                   //var19 = g.Key.C6_CCODIGO,
                                   var21 = ((from t2 in ctx.AL0003MOVD
                                             where t2.C6_CALMA == g.Key.C5_CALMA && t2.C6_CTD == g.Key.C5_CTD && t2.C6_CNUMDOC == g.Key.C5_CNUMDOC
                                             select new { t2.C6_CCODIGO }).FirstOrDefault().C6_CCODIGO.Substring(0, 2)),
                                   var22 = (decimal)g.Sum(p => p.d.C6_NCANTID),
                                   var23 = g.Key.OC_CNUMORD
                               }).ToList().Select(c => new SCabecera()
                               {
                                   C5_CALMA = c.var0,
                                   NOMAL = c.var1,
                                   //C5_CTD = c.var2,
                                   C5_CNUMDOC = c.var3,
                                   C5_DFECDOC = String.Format("{0:dd/MM/yyyy}", c.var5),
                                   //C5_CSITUA = c.var8,
                                   C5_CCODPRO = c.var17 == null || c.var17.Trim() == "" ? "-" : c.var17.Trim(),
                                   C5_CNOMPRO = c.var18 == null || c.var18.Trim() == "" ? "-" : c.var18.Trim(),
                                   //C5_DFECCRE = String.Format("{0:dd/MM/yyyy}", c.var19),
                                   C6_CCODIGO = c.var21,
                                   C6_CDESCRI = tabla_parametros.ListarParametroID("ES", c.var21),
                                   C6_NCANTID = c.var22,
                                   C5_CNUMORD = c.var23
                               }).ToList();

                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND1;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="PDATA"></param>
        /// <returns></returns>
        public static List<SCabecera> listaCabeceraIX(AL0003MOVC PDATA)
        {
            List<SCabecera> listND1 = new List<SCabecera>();
            try
            {
                using (var ctx = new RSFACAR())
                {

                    listND1 = (from c in ctx.AL0003MOVC
                               join d in ctx.AL0003MOVD
                               on new { c.C5_CALMA, c.C5_CTD, c.C5_CNUMDOC }
                               equals new { C5_CALMA = d.C6_CALMA, C5_CTD = d.C6_CTD, C5_CNUMDOC = d.C6_CNUMDOC }
                               join oc in ctx.CO0003MOVC
                                  on new { c.C5_CNUMORD }
                                  equals new { C5_CNUMORD = oc.OC_CNUMORD }
                               where
                                (
                                 //(PDATA.C5_CCODPRO != null ? c.C5_CCODPRO == PDATA.C5_CCODPRO.Trim() : c.C5_CCODPRO != PDATA.C5_CCODPRO) &&
                                 (PDATA.C5_CNUMORD != null ? c.C5_CNUMORD.Trim() == PDATA.C5_CNUMORD.Trim() : c.C5_CNUMORD != PDATA.C5_CNUMORD)
                               //oc.OC_CSITORD == "5" || oc.OC_CSITORD=="4"
                               )
                               orderby c.C5_CNUMDOC ascending
                               group new { c, d } by new
                               {
                                   c.C5_CALMA,
                                   c.C5_CTD,
                                   c.C5_CNUMDOC,
                                   c.C5_CCODMOV,
                                   c.C5_DFECDOC,
                                   c.C5_CGLOSA1,
                                   c.C5_CCODPRO,
                                   c.C5_CNOMPRO,
                                   oc.OC_CNUMORD,
                                   c.C5_CSUBDIA,//SUBDIARIO
                                   c.C5_CCOMPRO//COMPROBANTE
                                   //c.C5_CALMA,
                                   //c.C5_CTD,
                                   //d.C6_CCODIGO
                               } into g
                               select new
                               {
                                   var0 = g.Key.C5_CALMA,
                                   var1 = ((from t1 in ctx.AL0003ALMA
                                            where t1.A1_CALMA == g.Key.C5_CALMA
                                            select new { t1.A1_CDESCRI }).FirstOrDefault().A1_CDESCRI),
                                   var2 = g.Key.C5_CTD,
                                   var3 = g.Key.C5_CNUMDOC,
                                   var4 = g.Key.C5_CCODMOV,
                                   var5 = g.Key.C5_DFECDOC,
                                   var6 = g.Key.C5_CGLOSA1,
                                   var17 = g.Key.C5_CCODPRO,
                                   var18 = g.Key.C5_CNOMPRO,
                                   //var19 = g.Key.C6_CCODIGO,
                                   var21 = ((from t2 in ctx.AL0003MOVD
                                             where t2.C6_CALMA == g.Key.C5_CALMA && t2.C6_CTD == g.Key.C5_CTD && t2.C6_CNUMDOC == g.Key.C5_CNUMDOC
                                             select new { t2.C6_CCODIGO }).FirstOrDefault().C6_CCODIGO.Substring(0, 2)),
                                   var22 = (decimal)g.Sum(p => p.d.C6_NCANTID),
                                   var23 = g.Key.OC_CNUMORD,
                                   var24 = g.Key.C5_CSUBDIA,
                                   var25 = g.Key.C5_CCOMPRO
                               }).ToList().Select(c => new SCabecera()
                               {
                                   C5_CALMA = c.var0,
                                   NOMAL = c.var1,
                                   C5_CTD = c.var2,
                                   C5_CNUMDOC = c.var3,
                                   C5_CCODMOV = c.var4,
                                   C5_DFECDOC = String.Format("{0:dd/MM/yyyy}", c.var5),
                                   C5_CGLOSA1 = c.var6,
                                   C5_CCODPRO = c.var17 == null || c.var17.Trim() == "" ? "-" : c.var17.Trim(),
                                   C5_CNOMPRO = c.var18 == null || c.var18.Trim() == "" ? "-" : c.var18.Trim(),
                                   //C5_DFECCRE = String.Format("{0:dd/MM/yyyy}", c.var19),
                                   C6_CCODIGO = c.var21,
                                   //C6_CDESCRI = tabla_parametros.ListarParametroID("ES", c.var21),
                                   C6_NCANTID = c.var22,
                                   C5_CNUMORD = c.var23,
                                   C5_CSUBDIA = c.var24,
                                   C5_CCOMPRO = c.var25
                               }).ToList();

                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND1;
        }
        // CODIGO EDGAR
        public static List<AL0003MOVC> ListarProveedoresED(string cod1, string cod2, DateTime fec1, DateTime fec2, string almacen)
        {
            var alumnos = new List<AL0003MOVC>();

            try
            {
                using (var ctx = new RSFACAR())
                {
                    alumnos = ctx.Database.SqlQuery<AL0003MOVC>("select * from  AL0003MOVC  where (C5_CCODPRO>= @cod1 and C5_CCODPRO<= @cod2) and (C5_DFECDOC>= @fec1 and C5_DFECDOC<= @fec2) and C5_CCODMOV='MP' AND C5_CRFTDOC='RQ' AND C5_CSITUA='V' and c5_calma = @almacen  ",
                           new SqlParameter("cod1", cod1), new SqlParameter("cod2", cod2),
                           new SqlParameter("fec1", fec1), new SqlParameter("fec2", fec2)
                           , new SqlParameter("almacen", almacen))
                           .ToList();
                }
            }
            catch (Exception)
            {

                throw;
            }

            return alumnos;
        }

        public static List<VISTA_CPL> ComprasPLdetallado(AL0003MOVC PDATA)
        {
            string[] proveedor = PDATA.C5_CCODPRO.Split(',');
            List<VISTA_CPL> listND1 = new List<VISTA_CPL>();
            try
            {
                using (var ctx = new RSFACAR())
                {

                    //from articulo in ctx.AL0003ARTI
                    //join det in ctx.AL0003SKNU on new { AR_CCODIGO = articulo.AR_CCODIGO } equals new { AR_CCODIGO = det.SA_CCODIGO }

                    listND1 = (from c in ctx.AL0003MOVC
                               join d in ctx.AL0003MOVD
                               on new { C5_CNUMDOC = c.C5_CNUMDOC } equals new { C5_CNUMDOC = d.C6_CNUMDOC }
                               where
                               (c.C5_CALMA == PDATA.C5_CALMA &&
                                 (c.C5_CCODMOV == "MP") &&
                                 (c.C5_CRFTDOC == "RQ") &&
                                 (c.C5_CSITUA == "V") &&
                                 ((proveedor).Contains(c.C5_CCODPRO.Trim())) &&
                                 (c.C5_DFECDOC >= PDATA.C5_DFECDOC && c.C5_DFECDOC <= PDATA.C5_DFECMOD))
                               select new
                               {
                                   C5_CALMA = c.C5_CALMA,
                                   C5_CTD = c.C5_CTD,
                                   C5_CNUMDOC = c.C5_CNUMDOC,
                                   C5_CNOMPRO = c.C5_CNOMPRO,
                                   C5_CCODPRO = c.C5_CCODPRO,
                                   C5_DFECDOC = c.C5_DFECDOC,
                                   C6_CALMA = d.C6_CALMA,
                                   C6_CCODIGO = d.C6_CCODIGO,
                                   C6_CDESCRI = d.C6_CDESCRI,
                                   C6_NCANTID = d.C6_NCANTID,
                                   C6_NCANTEN = d.C6_NCANTEN,
                                   C6_CVANEXO = d.C6_CVANEXO,
                                   unidad = ((from t2 in ctx.AL0003ARTI
                                              where t2.AR_CCODIGO == d.C6_CCODIGO
                                              select new { t2.AR_CUNIDAD }).FirstOrDefault().AR_CUNIDAD),


                               }).ToList().Select(c => new VISTA_CPL()
                               {
                                   C5_CALMA = c.C5_CALMA,
                                   C5_CTD = c.C5_CTD,
                                   C5_CNUMDOC = c.C5_CNUMDOC,
                                   C5_CNOMPRO = c.C5_CNOMPRO,
                                   C5_CCODPRO = c.C5_CCODPRO,
                                   C5_DFECDOC = Convert.ToDateTime(c.C5_DFECDOC),
                                   C6_CALMA = c.C6_CALMA,
                                   C6_CCODIGO = c.C6_CCODIGO,
                                   C6_CDESCRI = c.C6_CDESCRI,
                                   C6_NCANTID = c.C6_NCANTID,
                                   C6_NCANTEN = c.C6_NCANTEN,
                                   C6_CVANEXO = c.C6_CVANEXO,
                                   unidad = c.unidad,

                               }).ToList();

                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND1;
        }

        public static List<VISTA_AL0003MOVC> ComprasPLResumido(AL0003MOVC PDATA)
        {
            string[] proveedor = PDATA.C5_CCODPRO.Split(',');
            List<VISTA_AL0003MOVC> listND1 = new List<VISTA_AL0003MOVC>();
            try
            {
                using (var ctx = new RSFACAR())
                {

                    listND1 = (from c in ctx.AL0003MOVC
                               where
                               (
                               (c.C5_CALMA == PDATA.C5_CALMA) &&
                                 (c.C5_CCODMOV == "MP") &&
                                 (c.C5_CRFTDOC == "RQ") &&
                                 (c.C5_CSITUA == "V")
                                 &&
                                 ((proveedor).Contains(c.C5_CCODPRO.Trim())) &&
                                 (c.C5_DFECDOC >= PDATA.C5_DFECDOC && c.C5_DFECDOC <= PDATA.C5_DFECMOD)
                               )
                               select new
                               {
                                   C5_CALMA = c.C5_CALMA,
                                   C5_CTD = c.C5_CTD,
                                   C5_CNUMDOC = c.C5_CNUMDOC,
                                   C5_CNOMPRO = c.C5_CNOMPRO,
                                   C5_CCODPRO = c.C5_CCODPRO,
                                   C5_DFECDOC = c.C5_DFECDOC,

                               }).ToList().Select(c => new VISTA_AL0003MOVC()
                               {
                                   C5_CALMA = c.C5_CALMA,
                                   C5_CTD = c.C5_CTD,
                                   C5_CNUMDOC = c.C5_CNUMDOC,
                                   C5_CNOMPRO = c.C5_CNOMPRO,
                                   C5_CCODPRO = c.C5_CCODPRO,
                                   C5_DFECDOC = Convert.ToDateTime(c.C5_DFECDOC),

                               }).ToList();
                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND1;
        }

        public static List<SCabecera> listadetalleCAB(AL0003MOVC PDATA, string[] ND)
        {
            List<SCabecera> listND1 = new List<SCabecera>();
            try
            {
                using (var ctx = new RSFACAR())
                {

                    listND1 = (from c in ctx.AL0003MOVC
                               join d in ctx.AL0003MOVD
                                   on new { c.C5_CALMA, c.C5_CTD, c.C5_CNUMDOC }
                               equals new { C5_CALMA = d.C6_CALMA, C5_CTD = d.C6_CTD, C5_CNUMDOC = d.C6_CNUMDOC }
                               join a in ctx.AL0003ARTI
                                   on new { d.C6_CCODIGO }
                               equals new { C6_CCODIGO = a.AR_CCODIGO }
                               /*join e in ctx.FT0003CTAE
                                   on new { a.AR_CCUENTA }
                                   equals new { AR_CCUENTA = e.TC_CEXISTE }*/
                               where
                               (c.C5_CALMA == PDATA.C5_CALMA && c.C5_CTD == PDATA.C5_CTD &&
                                 (ND).Contains(c.C5_CNUMDOC) &&
                                 //(PDATA.C5_CNUMDOC != null ? (miarray).Contains(c.C5_CNUMDOC) : c.C5_CNUMDOC != PDATA.C5_CNUMDOC) &&
                                 (PDATA.C5_CCODMOV != null ? c.C5_CCODMOV == PDATA.C5_CCODMOV : c.C5_CCODMOV != PDATA.C5_CCODMOV) &&
                                 (PDATA.C5_CRFTDOC != null ? c.C5_CRFTDOC != PDATA.C5_CRFTDOC : c.C5_CRFTDOC == PDATA.C5_CRFTDOC) &&
                                 (PDATA.C5_CCODPRO != null ? c.C5_CCODPRO == PDATA.C5_CCODPRO : c.C5_CCODPRO != PDATA.C5_CCODPRO)
                               )
                               orderby c.C5_CNUMDOC ascending
                               group new { c, d } by new//group new { c, d, a, e } by new
                               {
                                   /*SI QUITO NUMERO DOCUMENTO ES RESUMIDO*/
                                   /*c.C5_CNUMDOC,*/
                                   a.AR_CDESCR2,
                                   d.C6_NPREUNI,
                                   d.C6_NPREUN1,
                                   d.C6_NMNPRUN,
                                   d.C6_CCODMON
                               } into g
                               select new
                               {
                                   var21 = g.Key.AR_CDESCR2,
                                   var22 = (decimal)g.Sum(p => p.d.C6_NCANTID),
                                   var25 = ((from t in ctx.AL0003ARTI
                                             where t.AR_CDESCR2 == g.Key.AR_CDESCR2
                                             select new { t.AR_CUNIDAD }).FirstOrDefault().AR_CUNIDAD),
                                   var26 = g.Key.C6_NPREUNI,
                                   var27 = g.Key.C6_NPREUN1,
                                   var28 = g.Key.C6_NMNPRUN,
                                   var29 = g.Key.C6_CCODMON,//NUEVO 
                               }).ToList().Select(c => new SCabecera()
                               {
                                   C6_CDESCRI = c.var21,
                                   C6_NCANTID = c.var22,
                                   AR_CUNIDAD = c.var25,
                                   C6_NPREUNI = c.var26,
                                   C6_NPREUN1 = c.var27,
                                   C6_NMNPRUN = c.var28,
                                   C6_CCODMON = c.var29
                               }).ToList();

                }
            }
            catch (Exception)
            {
                throw;
            }
            return listND1;
        }
    }
}
